!function(){'use strict';var inNodeJS=!1;if('undefined'!=typeof process&&!process.browser){inNodeJS=!0;var request=require('request'.trim())}var supportsCORS=!1,inLegacyIE=!1;try{void 0!==(new XMLHttpRequest).withCredentials?supportsCORS=!0:'XDomainRequest'in window&&(supportsCORS=!0,inLegacyIE=!0)}catch(e){}var indexOfProto=Array.prototype.indexOf,ttIndexOf=function(array,item){var i=0,l=array.length;if(indexOfProto&&array.indexOf===indexOfProto)return array.indexOf(item);for(;i<l;i++)if(array[i]===item)return i;return-1},Tabletop=function(options){return this&&this instanceof Tabletop?('string'==typeof options&&(options={key:options}),this.callback=options.callback,this.wanted=options.wanted||[],this.key=options.key,this.simpleSheet=!!options.simpleSheet,this.parseNumbers=!!options.parseNumbers,this.wait=!!options.wait,this.reverse=!!options.reverse,this.postProcess=options.postProcess,this.debug=!!options.debug,this.query=options.query||'',this.orderby=options.orderby,this.endpoint=options.endpoint||'https://spreadsheets.google.com',this.singleton=!!options.singleton,this.simpleUrl=!(!options.simpleUrl&&!options.simple_url),this.callbackContext=options.callbackContext,this.prettyColumnNames=void 0===options.prettyColumnNames?!options.proxy:options.prettyColumnNames,void 0!==options.proxy&&(this.endpoint=options.proxy.replace(/\/$/,''),this.simpleUrl=!0,this.singleton=!0,supportsCORS=!1),this.parameterize=options.parameterize||!1,this.singleton&&(void 0!==Tabletop.singleton&&this.log('WARNING! Tabletop singleton already defined'),Tabletop.singleton=this),/key=/.test(this.key)&&(this.log('You passed an old Google Docs url as the key! Attempting to parse.'),this.key=this.key.match('key=(.*?)(&|#|$)')[1]),/pubhtml/.test(this.key)&&(this.log('You passed a new Google Spreadsheets url as the key! Attempting to parse.'),this.key=this.key.match('d\\/(.*?)\\/pubhtml')[1]),/spreadsheets\/d/.test(this.key)&&(this.log('You passed the most recent version of Google Spreadsheets url as the key! Attempting to parse.'),this.key=this.key.match('d\\/(.*?)/')[1]),this.key?(this.log('Initializing with key '+this.key),this.models={},this.modelNames=[],this.model_names=this.modelNames,this.baseJsonPath='/feeds/worksheets/'+this.key+'/public/basic?alt=',this.baseJsonPath+=inNodeJS||supportsCORS?'json':'json-in-script',void(this.wait||this.fetch())):void this.log('You need to pass Tabletop a key!')):new Tabletop(options)};Tabletop.callbacks={},Tabletop.init=function(options){return new Tabletop(options)},Tabletop.sheets=function(){this.log('Times have changed! You\'ll want to use var tabletop = Tabletop.init(...); tabletop.sheets(...); instead of Tabletop.sheets(...)')},Tabletop.prototype={fetch:function(callback){void 0!==callback&&(this.callback=callback),this.requestData(this.baseJsonPath,this.loadSheets)},requestData:function(path,callback){if(this.log('Requesting',path),inNodeJS)this.serverSideFetch(path,callback);else{var protocol=this.endpoint.split('//').shift()||'http';!supportsCORS||inLegacyIE&&protocol!==location.protocol?this.injectScript(path,callback):this.xhrFetch(path,callback)}},xhrFetch:function(path,callback){var xhr=inLegacyIE?new XDomainRequest:new XMLHttpRequest;xhr.open('GET',this.endpoint+path);var self=this;xhr.onload=function(){var json;try{json=JSON.parse(xhr.responseText)}catch(e){console.error(e)}callback.call(self,json)},xhr.send()},injectScript:function(path,callback){var callbackName,script=document.createElement('script');if(this.singleton)callback===this.loadSheets?callbackName='Tabletop.singleton.loadSheets':callback===this.loadSheet&&(callbackName='Tabletop.singleton.loadSheet');else{var self=this;callbackName='tt'+ +new Date+Math.floor(1e5*Math.random()),Tabletop.callbacks[callbackName]=function(){var args=Array.prototype.slice.call(arguments,0);callback.apply(self,args),script.parentNode.removeChild(script),delete Tabletop.callbacks[callbackName]},callbackName='Tabletop.callbacks.'+callbackName}var url=path+'&callback='+callbackName;this.simpleUrl?path.indexOf('/list/')!==-1?script.src=this.endpoint+'/'+this.key+'-'+path.split('/')[4]:script.src=this.endpoint+'/'+this.key:script.src=this.endpoint+url,this.parameterize&&(script.src=this.parameterize+encodeURIComponent(script.src)),this.log('Injecting',script.src),document.getElementsByTagName('script')[0].parentNode.appendChild(script)},serverSideFetch:function(path,callback){var self=this;this.log('Fetching',this.endpoint+path),request({url:this.endpoint+path,json:!0},function(err,resp,body){if(err)return console.error(err);callback.call(self,body)})},isWanted:function(sheetName){return 0===this.wanted.length||ttIndexOf(this.wanted,sheetName)!==-1},data:function(){if(0!==this.modelNames.length)return this.simpleSheet?(this.modelNames.length>1&&this.debug&&this.log('WARNING You have more than one sheet but are using simple sheet mode! Don\'t blame me when something goes wrong.'),this.models.googleSheetName=this.googleSheetName,this.models[this.modelNames[0]].all()):(this.models.googleSheetName=this.googleSheetName,this.models)},addWanted:function(sheet){ttIndexOf(this.wanted,sheet)===-1&&this.wanted.push(sheet)},loadSheets:function(data){var i,ilen,toLoad=[];for(this.googleSheetName=data.feed.title.$t,this.foundSheetNames=[],i=0,ilen=data.feed.entry.length;i<ilen;i++)if(this.foundSheetNames.push(data.feed.entry[i].title.$t),this.isWanted(data.feed.entry[i].content.$t)){var linkIdx=data.feed.entry[i].link.length-1,sheetId=data.feed.entry[i].link[linkIdx].href.split('/').pop(),jsonPath='/feeds/list/'+this.key+'/'+sheetId+'/public/values?alt=';jsonPath+=inNodeJS||supportsCORS?'json':'json-in-script',this.query&&(jsonPath+='&tq='+this.query),this.orderby&&(jsonPath+='&orderby=column:'+this.orderby.toLowerCase()),this.reverse&&(jsonPath+='&reverse=true'),toLoad.push(jsonPath)}for(this.sheetsToLoad=toLoad.length,i=0,ilen=toLoad.length;i<ilen;i++)this.requestData(toLoad[i],this.loadSheet)},sheets:function(sheetName){return void 0===sheetName?this.models:void 0===this.models[sheetName]?void 0:this.models[sheetName]},sheetReady:function(model){this.models[model.name]=model,ttIndexOf(this.modelNames,model.name)===-1&&this.modelNames.push(model.name),0===--this.sheetsToLoad&&this.doCallback()},loadSheet:function(data){var that=this;new Tabletop.Model({data:data,parseNumbers:this.parseNumbers,postProcess:this.postProcess,tabletop:this,prettyColumnNames:this.prettyColumnNames,onReady:function(){that.sheetReady(this)}})},doCallback:function(){0===this.sheetsToLoad&&this.callback.apply(this.callbackContext||this,[this.data(),this])},log:function(){this.debug&&'undefined'!=typeof console&&void 0!==console.log&&Function.prototype.apply.apply(console.log,[console,arguments])}},Tabletop.Model=function(options){var i,j,ilen,jlen;if(this.columnNames=[],this.column_names=this.columnNames,this.name=options.data.feed.title.$t,this.tabletop=options.tabletop,this.elements=[],this.onReady=options.onReady,this.raw=options.data,void 0===options.data.feed.entry)return options.tabletop.log('Missing data for '+this.name+', make sure you didn\'t forget column headers'),this.originalColumns=[],this.elements=[],void this.onReady.call(this);for(var key in options.data.feed.entry[0])/^gsx/.test(key)&&this.columnNames.push(key.replace('gsx$',''));for(this.originalColumns=this.columnNames,this.original_columns=this.originalColumns,i=0,ilen=options.data.feed.entry.length;i<ilen;i++){var source=options.data.feed.entry[i],element={};for(j=0,jlen=this.columnNames.length;j<jlen;j++){var cell=source['gsx$'+this.columnNames[j]];void 0!==cell?options.parseNumbers&&''!==cell.$t&&!isNaN(cell.$t)?element[this.columnNames[j]]=+cell.$t:element[this.columnNames[j]]=cell.$t:element[this.columnNames[j]]=''}void 0===element.rowNumber&&(element.rowNumber=i+1),options.postProcess&&options.postProcess(element),this.elements.push(element)}options.prettyColumnNames?this.fetchPrettyColumns():this.onReady.call(this)},Tabletop.Model.prototype={all:function(){return this.elements},fetchPrettyColumns:function(){if(!this.raw.feed.link[3])return this.ready();var cellurl=this.raw.feed.link[3].href.replace('/feeds/list/','/feeds/cells/').replace('https://spreadsheets.google.com',''),that=this;this.tabletop.requestData(cellurl,function(data){that.loadPrettyColumns(data)})},ready:function(){this.onReady.call(this)},loadPrettyColumns:function(data){for(var prettyColumns={},columnNames=this.columnNames,i=0,l=columnNames.length;i<l;i++)void 0!==data.feed.entry[i].content.$t?prettyColumns[columnNames[i]]=data.feed.entry[i].content.$t:prettyColumns[columnNames[i]]=columnNames[i];this.prettyColumns=prettyColumns,this.pretty_columns=this.prettyColumns,this.prettifyElements(),this.ready()},prettifyElements:function(){var i,j,ilen,jlen,prettyElements=[],orderedPrettyNames=[];for(j=0,jlen=this.columnNames.length;j<jlen;j++)orderedPrettyNames.push(this.prettyColumns[this.columnNames[j]]);for(i=0,ilen=this.elements.length;i<ilen;i++){var newElement={};for(j=0,jlen=this.columnNames.length;j<jlen;j++){newElement[this.prettyColumns[this.columnNames[j]]]=this.elements[i][this.columnNames[j]]}prettyElements.push(newElement)}this.elements=prettyElements,this.columnNames=orderedPrettyNames},toArray:function(){var i,j,ilen,jlen,array=[];for(i=0,ilen=this.elements.length;i<ilen;i++){var row=[];for(j=0,jlen=this.columnNames.length;j<jlen;j++)row.push(this.elements[i][this.columnNames[j]]);array.push(row)}return array}},'undefined'!=typeof module&&module.exports?module.exports=Tabletop:'function'==typeof define&&define.amd?define(function(){return Tabletop}):window.Tabletop=Tabletop}();